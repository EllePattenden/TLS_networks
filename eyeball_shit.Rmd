---
title: "Untitled"
author: "Elle Pattenden"
date: "18/05/2021"
output: html_document
---

```{r}
library(tidyverse)
library(igraph)
library(data.table)
library(Matrix)
```


```{r}
# rho1_ri10_15 <- data[[1]]
# rho1_ri10_15[, tick := .I - 1]
# rho1_ri10_15 <- na.omit(rho1_ri10_15, "prop_coop")
# net_rho1_ri10_15 <- data[[2]]     # get ties
# att__rho1_ri10_15 <- data[[3]]    # get attributes

rho1_ri10_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri10_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri10_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri10_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri10_15, aes(x = tick)) + geom_line(aes(y = prop_coop))


# networks 
names(net_rho1_ri10_15) <- seq_along(net_rho1_ri10_15) - 1 # label with tick 
net_rho1_ri10_15[sapply(net_rho1_ri10_15, is.null)] <- NULL   # remove empty
networks_to_plot <- names(net_rho1_ri10_15)  # for plotting 

for (net in networks_to_plot) {
  print(net)
  edge_list <- att__rho1_ri10_15 %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri10_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
    

```


```{r}
# rho1_ri20_15 <- data[[1]]
# rho1_ri20_15[, tick := .I - 1]
# rho1_ri20_15 <- na.omit(rho1_ri20_15, "prop_coop")
# # networks
# net_rho1_ri20_15 <- data[[2]]     # get ties
# att_rho1_ri20_15 <- data[[3]]    # get attributes
# names(net_rho1_ri20_15) <- seq_along(net_rho1_ri20_15) - 1 # label with tick
# net_rho1_ri20_15[sapply(net_rho1_ri20_15, is.null)] <- NULL   # remove empty

rho1_ri20_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri20_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri20_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri20_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri20_15, aes(x = tick)) + geom_line(aes(y = prop_coop))



networks_to_plot <- names(net_rho1_ri20_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

for (net in networks_to_plot) {
  edge_list <- att_rho1_ri20_15  %>% filter(tick == net) %>% select(id, 
                                                                    strategy)
  network <- graph.adjacency(net_rho1_ri20_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
    
```

Not at equilibrium! As expected, because ties will continue to be updated here until homogeneous communities are formed (as per Min et al. fig 4)! 


```{r}
# rho1_ri30_15 <- data[[1]]
# rho1_ri30_15[, tick := .I - 1]
# rho1_ri30_15 <- na.omit(rho1_ri30_15, "prop_coop")
# # networks
# net_rho1_ri30_15 <- data[[2]]     # get ties
# att_rho1_ri30_15 <- data[[3]]    # get attributes
# names(net_rho1_ri30_15) <- seq_along(net_rho1_ri30_15) - 1 # label with tick
# net_rho1_ri30_15[sapply(net_rho1_ri30_15, is.null)] <- NULL   # remove empty


rho1_ri30_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri30_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri30_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri30_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri30_15, aes(x = tick)) + geom_line(aes(y = prop_coop))


networks_to_plot <- names(net_rho1_ri30_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

for (net in networks_to_plot) {
  edge_list <- att_rho1_ri30_15  %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri30_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```


Again, not at equilibria. I think I might need to change the way that agent_ii is selected:
- could match strategies; e.g, if agent_i was a cooperator and agent_j was a defector, select 
  agent_ii randomly from all cooperators and agent_jj randomly from their defectin neighbours? 



```{r}
# rho1_ri40_15 <- data[[1]]
# rho1_ri40_15[, tick := .I - 1]
# rho1_ri40_15 <- na.omit(rho1_ri40_15, "prop_coop")
# # networks
# net_rho1_ri40_15 <- data[[2]]     # get ties
# att_rho1_ri40_15 <- data[[3]]    # get attributes
# names(net_rho1_ri40_15) <- seq_along(net_rho1_ri40_15) - 1 # label with tick
# net_rho1_ri40_15[sapply(net_rho1_ri40_15, is.null)] <- NULL   # remove empty

networks_to_plot <- names(net_rho1_ri40_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

rho1_ri40_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri40_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri40_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri40_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri40_15, aes(x = tick)) + geom_line(aes(y = prop_coop))


for (net in networks_to_plot) {
  edge_list <- att_rho1_ri40_15  %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri40_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```

Cooperators recover (but not completely) from initial wave of invasion, though system is not in equilibrium at the end. 

Probing network dynamics in this period: 

```{r}
# names(net_rho1_ri40_15)
networks_to_plot <- names(net_rho1_ri40_15)
networks_to_plot <- c(head(networks_to_plot, 1), 
                      "278", "709", "885", "917", "5454", "9159","12811",
                      tail(networks_to_plot, 1))

for (net in networks_to_plot) {
  edge_list <- att_rho1_ri40_15  %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri40_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```

Can see that when defectors are integrated in the community (start of run), the population is most at risk for spreading. 
- this is interesting for my hypothesis about strategically forming ties with defectors being beneficial; pretty sure it still will be when I change the role of networks ties (~cont. time version)


```{r}
# rho1_ri50_15 <- data[[1]]
# rho1_ri50_15[, tick := .I - 1]
# rho1_ri50_15 <- na.omit(rho1_ri50_15, "prop_coop")
# # networks
# net_rho1_ri50_15 <- data[[2]]     # get ties
# att_rho1_ri50_15 <- data[[3]]    # get attributes
# names(net_rho1_ri50_15) <- seq_along(net_rho1_ri50_15) - 1 # label with tick
# net_rho1_ri50_15[sapply(net_rho1_ri50_15, is.null)] <- NULL   # remove empty

networks_to_plot <- names(net_rho1_ri50_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

rho1_ri50_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri50_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri50_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri50_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri50_15, aes(x = tick)) + geom_line(aes(y = prop_coop))


for (net in networks_to_plot) {
  edge_list <- att_rho1_ri50_15  %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri50_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```



```{r}
# rho1_ri60_15 <- data[[1]]
# rho1_ri60_15[, tick := .I - 1]
# rho1_ri60_15 <- na.omit(rho1_ri60_15, "prop_coop")
# # networks
# net_rho1_ri60_15 <- data[[2]]     # get ties
# att_rho1_ri60_15 <- data[[3]]    # get attributes
# names(net_rho1_ri60_15) <- seq_along(net_rho1_ri60_15) - 1 # label with tick
# net_rho1_ri60_15[sapply(net_rho1_ri60_15, is.null)] <- NULL   # remove empty

rho1_ri60_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho1_ri60_15, aes(x = tick)) + 
  geom_line(aes(y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho1_ri60_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho1_ri60_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho1_ri60_15, aes(x = tick)) + geom_line(aes(y = prop_coop))

networks_to_plot <- names(net_rho1_ri60_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

for (net in networks_to_plot) {
  edge_list <- att_rho1_ri60_15  %>% filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho1_ri60_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```

```{r}
# rho.9_ri10_15 <- data[[1]]
# rho.9_ri10_15[, tick := .I - 1]
# rho.9_ri10_15 <- na.omit(rho.9_ri10_15, "prop_coop")
# net_rho.9_ri10_15 <- data[[2]]     # get ties
# att__rho.9_ri10_15 <- data[[3]]    # get attributes
# ## networks 
# names(net_rho.9_ri10_15) <- seq_along(net_rho.9_ri10_15) - 1 # label with tick 
# net_rho.9_ri10_15[sapply(net_rho.9_ri10_15, is.null)] <- NULL   # remove empty

networks_to_plot <- names(net_rho.9_ri10_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

rho.9_ri10_15[which.max(prop_coop), .(prop_coop, tick)]

ggplot(rho.9_ri10_15, aes(x = tick)) + geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho.9_ri10_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho.9_ri10_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho.9_ri10_15, aes(x = tick)) + geom_line(aes(y = prop_coop))


for (net in networks_to_plot) {
  print(net)
  edge_list <- att__rho.9_ri10_15 %>% filter(tick == net) %>% 
    select(id, strategy)
  network <- graph.adjacency(net_rho.9_ri10_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
   
```


```{r}
# rho.9_ri20_15 <- data[[1]]
# rho.9_ri20_15[, tick := .I - 1]
# rho.9_ri20_15 <- na.omit(rho.9_ri20_15, "prop_coop")
# # networks
# net_rho.9_ri20_15 <- data[[2]]     # get ties
# att_rho.9_ri20_15 <- data[[3]]    # get attributes
# names(net_rho.9_ri20_15) <- seq_along(net_rho.9_ri20_15) - 1 # label with tick
# net_rho.9_ri20_15[sapply(net_rho.9_ri20_15, is.null)] <- NULL   # remove empty
networks_to_plot <- names(net_rho.9_ri20_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

rho.9_ri20_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho.9_ri20_15, aes(x = tick)) + 
  geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho.9_ri20_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho.9_ri20_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho.9_ri20_15, aes(x = tick)) + geom_line(aes(y = prop_coop))

for (net in networks_to_plot) {
  edge_list <- att_rho.9_ri20_15  %>% filter(tick == net) %>% 
    select(id, strategy)
  network <- graph.adjacency(net_rho.9_ri20_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
    
```

Not in equ. 

```{r}
# rho.9_ri30_15 <- data[[1]]
# rho.9_ri30_15[, tick := .I - 1]
# rho.9_ri30_15 <- na.omit(rho.9_ri30_15, "prop_coop")
# # networks
# net_rho.9_ri30_15 <- data[[2]]     # get ties
# att_rho.9_ri30_15 <- data[[3]]    # get attributes
# names(net_rho.9_ri30_15) <- seq_along(net_rho.9_ri30_15) - 1 # label with tick
# net_rho.9_ri30_15[sapply(net_rho.9_ri30_15, is.null)] <- NULL   # remove empty

networks_to_plot <- names(net_rho.9_ri30_15)  # for plotting 
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))

rho.9_ri30_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho.9_ri30_15, aes(x = tick)) + 
  geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho.9_ri30_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho.9_ri30_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho.9_ri30_15, aes(x = tick)) + geom_line(aes(y = prop_coop))

for (net in networks_to_plot) {
  edge_list <- att_rho.9_ri30_15  %>% 
    filter(tick == net) %>% 
    select(id, strategy)
  network <- graph.adjacency(net_rho.9_ri30_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```


```{r}
# rho.9_ri40_15 <- data[[1]]
# rho.9_ri40_15[, tick := .I - 1]
# rho.9_ri40_15 <- na.omit(rho.9_ri40_15, "prop_coop")
# # networks
# net_rho.9_ri40_15 <- data[[2]]     # get ties
# att_rho.9_ri40_15 <- data[[3]]    # get attributes
# names(net_rho.9_ri40_15) <- seq_along(net_rho.9_ri40_15) - 1 # label with tick
# net_rho.9_ri40_15[sapply(net_rho.9_ri40_15, is.null)] <- NULL   # remove empty



networks_to_plot <- names(net_rho.9_ri40_15)  # for plotting
networks_to_plot <- c(head(networks_to_plot, 1), tail(networks_to_plot, 1))


rho.9_ri40_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho.9_ri40_15, aes(x = tick)) + 
  geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho.9_ri40_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho.9_ri40_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho.9_ri40_15, aes(x = tick)) + geom_line(aes(y = prop_coop))

for (net in networks_to_plot) {
  edge_list <- att_rho.9_ri40_15  %>% 
    filter(tick == net) %>% 
    select(id, strategy)
  network <- graph.adjacency(net_rho.9_ri40_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```



```{r}
# rho.9_ri50_15 <- data[[1]]
# rho.9_ri50_15[, tick := .I - 1]
# rho.9_ri50_15 <- na.omit(rho.9_ri50_15, "prop_coop")
# # networks
# net_rho.9_ri50_15 <- data[[2]]     # get ties
# att_rho.9_ri50_15 <- data[[3]]    # get attributes
# names(net_rho.9_ri50_15) <- seq_along(net_rho.9_ri50_15) - 1 # label with tick
# net_rho.9_ri50_15[sapply(net_rho.9_ri50_15, is.null)] <- NULL   # remove empty

rho.9_ri50_15[which.min(prop_coop), .(prop_coop, tick)]

ggplot(rho.9_ri50_15, aes(x = tick)) + 
  geom_line(aes( y = R_now), color = "green")  + 
  geom_line(aes(y = total_harvest), color = "red")

ggplot(rho.9_ri50_15, aes(x = tick, y = total_e)) + geom_line()

ggplot(rho.9_ri50_15, aes(x = tick)) + 
geom_line(aes(y = coop_U), color = "blue")  + 
  geom_line(aes(y = defector_U,), color = "red") +        # average
  geom_line(aes(y = defector_pi), color = "orange") + 
  geom_line(aes(y = mag_ostracism)) + ylab("")      # average

ggplot(rho.9_ri50_15, aes(x = tick)) + geom_line(aes(y = prop_coop))

networks_to_plot <- names(net_rho.9_ri50_15)  # for plotting
networks_to_plot <- c(head(networks_to_plot, 1),"1595", "2000", tail(networks_to_plot, 1))

for (net in networks_to_plot) {
  edge_list <- att_rho.9_ri50_15  %>% 
    filter(tick == net) %>% select(id, strategy)
  network <- graph.adjacency(net_rho.9_ri50_15[as.character(net)][[1]], 
                             mode = "undirected")
  V(network)$strategy <-  edge_list$strategy
  V(network)$color <- ifelse(V(network)$strategy == 1, "green", "red")
  set.seed(1234)
  plot.igraph(network, layout = layout_with_lgl,
            vertex.size = 10,vertex.label.cex = 0.5)
}
```

Potentially interesting pattern around tick 2000, where defectors are being pushed to the edge of the network (thereby reducing their ability to influence cooperators BUT at the same time decreasing the ability of cooperators to sanction them)! Eventually, defectors take over. 





